
<svg width="100%" height="100%" viewBox="0 0 1179 122" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" fill="white" style="fill-rule: evenodd; clip-rule: evenodd; stroke-linejoin: round; stroke-miterlimit: 2; height: 50px; margin-top: 4px;"><g transform="matrix(1,0,0,1,-73.9597,-87.9925)"><g transform="matrix(125.644,0,0,125.644,200,178.072)"><path d="M0.32,0.017C0.5,0.017 0.617,-0.077 0.617,-0.214C0.617,-0.337 0.529,-0.415 0.351,-0.436C0.274,-0.445 0.24,-0.459 0.24,-0.501C0.24,-0.54 0.274,-0.565 0.34,-0.565C0.395,-0.565 0.456,-0.55 0.528,-0.517L0.587,-0.662C0.495,-0.703 0.425,-0.717 0.333,-0.717C0.165,-0.717 0.056,-0.629 0.056,-0.493C0.056,-0.371 0.138,-0.304 0.32,-0.286C0.406,-0.277 0.43,-0.251 0.43,-0.213C0.43,-0.167 0.391,-0.144 0.317,-0.144C0.254,-0.144 0.181,-0.166 0.106,-0.212L0.035,-0.061C0.128,-0.003 0.221,0.017 0.32,0.017Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,280.413,178.072)"><path d="M0.307,0.011C0.375,0.011 0.437,-0.009 0.494,-0.049L0.417,-0.172C0.388,-0.148 0.356,-0.135 0.317,-0.135C0.251,-0.135 0.209,-0.18 0.209,-0.249C0.209,-0.314 0.253,-0.359 0.321,-0.359C0.351,-0.359 0.383,-0.35 0.411,-0.329L0.484,-0.454C0.436,-0.488 0.373,-0.505 0.308,-0.505C0.14,-0.505 0.029,-0.402 0.029,-0.245C0.029,-0.087 0.135,0.011 0.307,0.011Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,343.486,178.072)"><path d="M0.27,-0.506C0.194,-0.506 0.135,-0.495 0.061,-0.468L0.091,-0.346C0.146,-0.363 0.195,-0.373 0.243,-0.373C0.314,-0.373 0.343,-0.349 0.343,-0.292L0.343,-0.291C0.314,-0.303 0.271,-0.312 0.226,-0.312C0.107,-0.312 0.027,-0.251 0.027,-0.15C0.027,-0.056 0.095,0.009 0.196,0.009C0.279,0.009 0.338,-0.037 0.36,-0.094L0.363,-0.094C0.358,-0.048 0.357,-0.023 0.357,-0L0.524,-0L0.524,-0.31C0.524,-0.445 0.442,-0.506 0.27,-0.506ZM0.26,-0.127C0.227,-0.127 0.207,-0.142 0.207,-0.168C0.207,-0.195 0.227,-0.212 0.265,-0.212C0.291,-0.212 0.322,-0.204 0.345,-0.195C0.338,-0.153 0.306,-0.127 0.26,-0.127Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,415.983,178.072)"><path d="M0.216,0.012C0.265,0.012 0.324,0.002 0.358,-0.019L0.329,-0.145C0.312,-0.138 0.297,-0.135 0.28,-0.135C0.251,-0.135 0.24,-0.156 0.24,-0.186L0.24,-0.7L0.058,-0.7L0.058,-0.161C0.058,-0.047 0.111,0.012 0.216,0.012Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,461.34,178.072)"><path d="M0.27,-0.506C0.194,-0.506 0.135,-0.495 0.061,-0.468L0.091,-0.346C0.146,-0.363 0.195,-0.373 0.243,-0.373C0.314,-0.373 0.343,-0.349 0.343,-0.292L0.343,-0.291C0.314,-0.303 0.271,-0.312 0.226,-0.312C0.107,-0.312 0.027,-0.251 0.027,-0.15C0.027,-0.056 0.095,0.009 0.196,0.009C0.279,0.009 0.338,-0.037 0.36,-0.094L0.363,-0.094C0.358,-0.048 0.357,-0.023 0.357,-0L0.524,-0L0.524,-0.31C0.524,-0.445 0.442,-0.506 0.27,-0.506ZM0.26,-0.127C0.227,-0.127 0.207,-0.142 0.207,-0.168C0.207,-0.195 0.227,-0.212 0.265,-0.212C0.291,-0.212 0.322,-0.204 0.345,-0.195C0.338,-0.153 0.306,-0.127 0.26,-0.127Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,533.837,178.072)"><path d="M0.385,0.011C0.515,0.011 0.613,-0.096 0.613,-0.25C0.613,-0.41 0.519,-0.505 0.396,-0.505C0.319,-0.505 0.256,-0.46 0.223,-0.4L0.22,-0.4C0.239,-0.474 0.242,-0.528 0.242,-0.595L0.242,-0.7L0.058,-0.7L0.058,-0L0.22,-0C0.22,-0.02 0.22,-0.041 0.217,-0.079L0.22,-0.079C0.252,-0.023 0.311,0.011 0.385,0.011ZM0.333,-0.136C0.273,-0.136 0.236,-0.181 0.236,-0.249C0.236,-0.314 0.277,-0.358 0.335,-0.358C0.395,-0.358 0.433,-0.312 0.433,-0.245C0.433,-0.179 0.391,-0.136 0.333,-0.136Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,614.501,178.072)"><path d="M0.216,0.012C0.265,0.012 0.324,0.002 0.358,-0.019L0.329,-0.145C0.312,-0.138 0.297,-0.135 0.28,-0.135C0.251,-0.135 0.24,-0.156 0.24,-0.186L0.24,-0.7L0.058,-0.7L0.058,-0.161C0.058,-0.047 0.111,0.012 0.216,0.012Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,659.858,178.072)"><path d="M0.549,-0.27C0.549,-0.42 0.442,-0.505 0.301,-0.505C0.171,-0.505 0.029,-0.426 0.029,-0.245C0.029,-0.066 0.16,0.011 0.311,0.011C0.394,0.011 0.468,-0.016 0.518,-0.062L0.444,-0.165C0.41,-0.139 0.371,-0.124 0.321,-0.124C0.28,-0.124 0.224,-0.147 0.213,-0.199L0.541,-0.199C0.547,-0.223 0.549,-0.248 0.549,-0.27ZM0.297,-0.375C0.34,-0.375 0.382,-0.349 0.376,-0.29L0.211,-0.29C0.214,-0.348 0.253,-0.375 0.297,-0.375Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,731.852,178.072)"><path d="M0.573,-0.7L0.016,-0.7L0.016,-0.645L0.265,-0.645L0.265,-0L0.324,-0L0.324,-0.645L0.573,-0.645L0.573,-0.7Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,792.036,178.072)"><path d="M0.529,-0.265C0.529,-0.417 0.435,-0.504 0.294,-0.504C0.151,-0.504 0.049,-0.396 0.049,-0.247C0.049,-0.096 0.15,0.01 0.296,0.01C0.37,0.01 0.449,-0.018 0.502,-0.072L0.471,-0.111C0.425,-0.066 0.356,-0.042 0.297,-0.042C0.19,-0.042 0.114,-0.114 0.106,-0.226L0.527,-0.226C0.528,-0.24 0.529,-0.253 0.529,-0.265ZM0.293,-0.452C0.404,-0.452 0.473,-0.388 0.475,-0.275L0.106,-0.275C0.118,-0.383 0.192,-0.452 0.293,-0.452Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,863.527,178.072)"><path d="M0.252,-0.501C0.194,-0.501 0.138,-0.488 0.076,-0.46L0.093,-0.413C0.142,-0.435 0.2,-0.45 0.25,-0.45C0.357,-0.45 0.424,-0.407 0.424,-0.313L0.424,-0.265C0.363,-0.296 0.304,-0.308 0.241,-0.308C0.126,-0.308 0.04,-0.251 0.04,-0.149C0.04,-0.049 0.123,0.009 0.23,0.009C0.32,0.009 0.397,-0.038 0.429,-0.108L0.431,-0.108C0.429,-0.073 0.429,-0.038 0.429,-0L0.481,-0L0.481,-0.313C0.481,-0.442 0.39,-0.501 0.252,-0.501ZM0.237,-0.042C0.159,-0.042 0.097,-0.082 0.097,-0.15C0.097,-0.219 0.159,-0.259 0.247,-0.259C0.305,-0.259 0.377,-0.242 0.426,-0.214C0.42,-0.11 0.337,-0.042 0.237,-0.042Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,933.888,178.072)"><path d="M0.305,0.01C0.371,0.01 0.433,-0.012 0.482,-0.054L0.454,-0.098C0.409,-0.06 0.356,-0.043 0.305,-0.043C0.197,-0.043 0.106,-0.118 0.106,-0.247C0.106,-0.377 0.197,-0.451 0.305,-0.451C0.354,-0.451 0.405,-0.434 0.446,-0.399L0.477,-0.442C0.429,-0.482 0.371,-0.504 0.306,-0.504C0.162,-0.504 0.049,-0.405 0.049,-0.247C0.049,-0.09 0.163,0.01 0.305,0.01Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,999.223,178.072)"><path d="M0.086,-0L0.143,-0L0.143,-0.271C0.143,-0.371 0.217,-0.449 0.322,-0.449C0.426,-0.449 0.481,-0.387 0.481,-0.28L0.481,-0L0.538,-0L0.538,-0.284C0.538,-0.422 0.463,-0.501 0.33,-0.501C0.242,-0.501 0.169,-0.453 0.141,-0.393L0.139,-0.393C0.142,-0.426 0.143,-0.471 0.143,-0.516L0.143,-0.7L0.086,-0.7L0.086,-0Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,1076.75,178.072)"><path d="M0.114,-0.601C0.141,-0.601 0.159,-0.62 0.159,-0.646C0.159,-0.671 0.141,-0.69 0.114,-0.69C0.088,-0.69 0.069,-0.671 0.069,-0.646C0.069,-0.62 0.088,-0.601 0.114,-0.601ZM0.086,-0L0.143,-0L0.143,-0.494L0.086,-0.494L0.086,-0Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,1105.52,178.072)"><path d="M0.086,-0L0.143,-0L0.143,-0.271C0.143,-0.371 0.217,-0.449 0.322,-0.449C0.426,-0.449 0.481,-0.387 0.481,-0.28L0.481,-0L0.538,-0L0.538,-0.284C0.538,-0.422 0.463,-0.501 0.33,-0.501C0.241,-0.501 0.169,-0.457 0.14,-0.391L0.138,-0.391C0.14,-0.428 0.14,-0.461 0.14,-0.494L0.086,-0.494L0.086,-0Z" style="fill-rule: nonzero;"></path></g> <g transform="matrix(125.644,0,0,125.644,1183.04,178.072)"><path d="M0.313,0.25C0.461,0.25 0.553,0.159 0.553,0.011L0.553,-0.494L0.498,-0.494C0.498,-0.438 0.498,-0.418 0.5,-0.38L0.498,-0.38C0.473,-0.451 0.393,-0.503 0.296,-0.503C0.152,-0.503 0.049,-0.397 0.049,-0.247C0.049,-0.098 0.152,0.007 0.297,0.007C0.392,0.007 0.472,-0.043 0.497,-0.111L0.499,-0.111C0.497,-0.071 0.496,-0.044 0.495,0.021C0.494,0.129 0.424,0.197 0.312,0.197C0.241,0.197 0.182,0.182 0.11,0.147L0.088,0.195C0.155,0.232 0.232,0.25 0.313,0.25ZM0.303,-0.046C0.188,-0.046 0.106,-0.129 0.106,-0.248C0.106,-0.367 0.186,-0.45 0.301,-0.45C0.417,-0.45 0.496,-0.369 0.496,-0.249C0.496,-0.126 0.42,-0.046 0.303,-0.046Z" style="fill-rule: nonzero;"></path></g></g> <g transform="matrix(1,0,0,1,-211.614,-178.072)"><g transform="matrix(0.836124,6.15741e-17,-9.22742e-17,-0.499529,34.6784,401.981)"><rect x="211.614" y="268.072" width="35.88" height="60.057"></rect></g> <g transform="matrix(0.836124,2.07526e-17,-3.10995e-17,-0.999057,74.6784,535.89)"><rect x="211.614" y="268.072" width="35.88" height="60.057"></rect></g> <g transform="matrix(0.836124,-2.0069e-17,3.00751e-17,-1.49859,114.678,669.8)"><rect x="211.614" y="268.072" width="35.88" height="60.057"></rect></g></g></svg>

ScalableTeaching is a complete software suite that enables easy assignment and task handling for the development of software.

ScalableTeaching currently relies on a GitLab + GitLab CI environment to serve as the backbone.

## Installation instructions

### Requirements

- PHP 8.1 installed on your machine
- Comoposer installed.
- A MySQL instance
- Node ~18
- Yarn (install with Node)

The solution is built on top of the Laravel web framework (v9), with Vue 2 powering some frontend components.

#### 1. Installing dependencies
Run `composer install` to install Laravel and the project's dependencies

Run `yarn` to install the node dependencies for the frontend.

#### 2. Configure environment variables

Copy the `.env.example` to a new `.env` file, and edit the following variables:

1. Setup the authentication. The authentication service uses GitLab's OAuth - configure the values below. If you are uncertain, these can be retrieved by inquirying the IT department.
    1. `GITLAB_CLIENT_ID`
    2. `GITLAB_CLIENT_SECRET`
    3. `GITLAB_REDIRECT_URL` should be set to the host and port of your application and append `/login/callback` to it.
    4. `GITLAB_URL` should refer to the url of the gitlab instance.
    5. `GITLAB_ACCESS_TOKEN` of the user ScalableTeaching should act as within GitLab.
2. Configure the database such that the application can establish a connection to your database
    1. `DB_HOST`
    2. `DB_PASSWORD`
    3. `DB_USERNAME`
3. Configure the `SCALABLE_SECRET`. This secret is used to ensure that student's don't tamper with the runner settings within their repo.
4. `GITLAB_GROUP_ID` Should be set to the id of the group id that all repositories and tasks should be created within.


#### 3. Migrate the database
Use the `php artisan migrate` command to migrate the database.

Additionally, if you want to populate it with dummy data, add `--seed` to the command, and if you want to migrate it from scratch again then run `migrate:fresh` instead.

## Development environment and CI

To enhance the developer workflow, this repository includes various tools to ensure a high quality of code.
Specifically:
- `php-cs-fixer` that ensures a consistent code style. Install php-cs-fixer globally by running `composer global require friendsofphp/php-cs-fixer`, after which you can run `php-cs-fixer fix` within the root of this project to fix issues.
- `larastan` that runs a suite of static analyses. You may check your code for pitfalls using the `php vendor/bin/phpstan`

A large portion of the code base is also covered by both unit and feature tests, these can be inspected within the `/tests` directory. The tests are written using the [PEST PHP testing framework](https://pestphp.com/).

You may trigger the tests by using the command `php artisan test`

You can also generate coverage by running `php artisan test --coverage-html html-coverage`

php-cs-fixer, larastan and tests are validated whenever you submit changes to the repo.

### Gitlab Backbone
As mentioned in the beginning ScalableTeaching is built on top of GitLab and GitLab CI.

This application communicates with GitLab via their [GraphQL API](https://docs.gitlab.com/ee/api/graphql/).  
We generate schema query objects with the package [php-graphql-oqm](https://github.com/mghoneimy/php-graphql-oqm), and any generated files can be found in the [/GraphQL](./GraphQL) folder.

_Last schema generation was: February 19th 2024, and the gitlab.sdu.dk was running on version **16.9**._


### Running the application

#### Frontend

Use `yarn watch` to create a development build of the frontend. This command will keep watching for file changes and automatically recreate the underlying files whenever you make changes.

#### Laravel
Run `php artisan serve` to start the laravel application. 

#### Database
Start the database.

This can be done by running `docker compose up`, which runs a development database and a in-memory MySQL test database, to avoid having to re-seed everytime the test are ran.  
Once you're done, you can shut them down by running `docker compose down`

#### Bonus
For testing Gitlab webhook changes, you can use the free tier of [Ngrok](https://ngrok.com) to expose your local environment to the outside world.
On your ngrok account, you will find a static domain, you can use this to ensure it's the same URL every time you spin it up.  

**_Note: I would not recommend developing against this tunnel connection, but purely use it for testing gitlab webhook events._**

After installed, you can run `ngrok http 8000 --domain <your static domain>` in the root of the project, which will spin up a tunnel connection for the static url.  
You can then set this static url in your `.env` file, the key is `GITLAB_WEBHOOK_URL`.

_**Note: If you own your own domain, I recommend using cloudflare tunnels as they are much more reliably.**_ 
_Can also be used without a domain, but requires switching the webhook url in GitLab every time you spin up the tunnel._

### Production server

#### Server location
The server which runs ScalableTeaching is located on the SDU network, and it is therefore required for you to connect with the SDU VPN (Cisco).
It's also **REQUIRED** to login to the VPN with your employee account so the account that ends in `@mmmi.sdu.dk`, this ensures you get routed differently on the SDU server.

Then you can SSH into the server with the account created like so: `<ACCOUNT_NAME>@scalable.srv.sdu.dk` and the password is your account password.

#### Deployment
TBD

#### Backup

Login to the server and run the following command to back up the app files. This will copy the files to your home directory, remove the storage, vendor and node_modules directories, and then compress the files into a tarball.
```bash
cp -r /var/www/sites/main/ ~/backup-app && rm -rf ~/backup-app/storage && rm -rf ~/backup-app/vendor && rm -rf ~/backup-app/node_modules && tar -zcvf ~/backup-app.tar.gz ~/backup-app
```

Next up backup the current database with mysqldump. This will create a dump of the database in a sql file, that can be replayed with 
```bash
mysqldump -u <USERNAME> -p <DATABASE_NAME> --result-file=~/scalable-db-backup.sql --no-tablespaces 
```

The backed up files can be copied to your local machine through the use of SCP.

#### Restoring a backup
To restore the database backup, you can run the following command. This will create a new database, and then replay the sql file into it.
```bash
mysql -u <USERNAME> -p && create database <DATABASE_NAME>; && use <DATABASE_NAME>; && source <PATH_TO_SQL_BACKUP_FILE>; 
```

TBD: Restoring the app files.

### FAQ

#### Fatal error: Allowed memory size of 134217728 bytes exhausted (tried to allocate 36864 bytes)
This means your PHP is configured with a memory limit that is too low to run the tests.

Update it by going to your php.ini file, and then searching for the field `memory_limit` and upping it. (Recommendation is to set it to `1G`)

#### Command not found: php-cs-fixer (Mac/Linux)
Ensure you have updated your . profile, for your terminal.

Example: `export PATH=<laravel vendor bin location>:$PATH`, for me it was under `~/.composer/vendor/bin`.
